# 滞留在庫ダッシュボード検証セッション

## 基本情報
- **日付**: 2026年1月15日
- **対象クエリ**: stagnant_inventory_dashboard_v2.sql (現在ダッシュボードに実装中)
- **改善版**: stagnant_inventory_dashboard_v3.sql (依存関係を改善済み)
- **背景**: ダッシュボードとパーツ単位の表 (滞留在庫_期末減損在庫_表) で数字が合わないという指摘

---

## 指摘事項のまとめ

### 2つのデータソースの違い

| データソース | 単位 | 用途 |
|-------------|------|------|
| ダッシュボード (廣瀬さん作成) | 商品単位 (組み上がり数) | 販促チラシ作成の基準 |
| 滞留在庫_期末減損在庫_表 (野口さん作成) | パーツ単位 | 簿価の管理 |

### 指摘された商品コード (KINFORTソファ)

| 商品コード | 商品名 | パーツ表 | ダッシュボード | 管理画面確認結果 |
|-----------|--------|----------|---------------|-----------------|
| 504-5129 | 2.5P セサミブラウン | あり | 商品数0 | 共通シートパネル1点がリカバリー中 |
| 504-5137 | 2.5P チャコールグレー | あり | **出てこない** | **全在庫貸出中** |
| 504-5105 | 2P ペブルグレー | あり | **出てこない** | クリーニング完了後1SKU復活予定 |
| 504-5101 | 2P ユーカリグリーン | あり | 3個 | - |
| 504-5117 | 2P チャコールグレー | あり | - | **全て貸出中** (B向け抑え中) |

---

## クエリ分析結果

### ダッシュボードの除外条件 (stocks CTE)

`stagnant_inventory_dashboard_v3.sql` の 148-230行目で定義:

| 除外条件 | 説明 | 該当行 |
|---------|------|--------|
| ステータス | Ready/Waiting/Recovery のみ対象 | 221行目 |
| **ランク R/L** | 除外される | 226行目 |
| toC引当準備中 | Preparing/Adjusting は除外 | 179-184行目 |
| toB引当準備中 | Preparing は除外 | 186-191行目 |
| B向け発注済み | 除外 | 202-210行目 |
| 外部販売中 | 除外 | 212-218行目 |
| 特定メモタグ | id=64 は除外 | 193-200行目 |

### 重要な発見

1. **貸出中 (Lent/LentToB) の在庫は stocks CTE に含まれない**
   - ステータスが `Ready/Waiting/Recovery` のみ対象
   - 貸出中の在庫はダッシュボードに反映されない

2. **だから「出てこない」のは正しい動作**
   - 丹羽さんの確認: チャコールグレーは全て貸出中
   - 倉庫に物理的に存在しない = ダッシュボードに出ない

3. **パーツ表との差異の原因**
   - パーツ表 = 簿価が残っているパーツ (貸出中も含む)
   - ダッシュボード = 倉庫にあって組み上がる在庫のみ

---

## ミーティングで挙がった追加の論点

1. **更新タイミングの問題**
   - 一部テーブルが1ヶ月に1回しか更新されない依存関係がある
   - 13日にステータスが変わったものが反映されていない可能性

2. **倉庫の分離**
   - パーツが別の倉庫 (関東と船橋など) にあると組み上がらない仕組み

3. **共通パーツの問題**
   - KINFORTソファ 2P 共通シートパネルが他カラバリと共有
   - 余りパーツとして残っている可能性

---

## 作成した検証用クエリ

| ファイル | 用途 |
|---------|------|
| `sql/verification/kinfort_investigation.sql` | 全在庫のステータス別詳細 |
| `sql/verification/kinfort_lent_status.sql` | 貸出中の在庫詳細 (toC/toB) |
| `sql/verification/kinfort_summary.sql` | 商品コードごとのサマリー (推奨) |

### kinfort_summary.sql の出力項目

| 項目 | 説明 |
|-----|------|
| 全在庫 | そのパーツの在庫総数 |
| Ready/Waiting/Recovery | 倉庫にある在庫 |
| Lent_toC/Lent_toB | 貸出中の在庫 |
| ランクR_L | 除外されるランクの在庫 |
| ダッシュボード対象 | 実際にダッシュボードに反映される数 |
| 組み上げ可能数 | 商品として組み上がる数 |

---

## 結論 (現時点)

**ダッシュボードの動作自体は正しい可能性が高い**

- 貸出中の在庫は対象外という仕様
- パーツ表は簿価ベース、ダッシュボードは物理在庫ベース
- 「差異がある」のではなく「見ているものが違う」

### 次のアクション

1. BigQueryで検証用クエリを実行して実データを確認
2. 管理画面の情報と突き合わせて差異の原因を特定
3. 必要に応じてダッシュボードの仕様説明ドキュメントを作成

---

## BigQuery 実行結果 (2026-01-15)

### 対象パーツ ID

| パーツID | 商品コード | 商品名 |
|---------|-----------|--------|
| 18099 | 504-5101 | KINFORTソファ2P フレーム & 背クッション / ユーカリグリーン |
| 18103 | 504-5105 | KINFORTソファ2P フレーム & 背クッション / ペブルグレー |
| 18109 | 504-5117 | KINFORTソファ2P フレーム & 背クッション / チャコールグレー |
| 18128 | 504-5129 | KINFORTソファ2.5P フレーム & 背クッション / セサミブラウン |
| 18135 | 504-5137 | KINFORTソファ2.5P フレーム & 背クッション / チャコールグレー |

### ステータス別在庫数サマリー

| パーツID | 商品コード | Ready/Waiting | Recovery | 貸出(toC) | 貸出(toB) | その他 | 合計 |
|---------|-----------|---------------|----------|-----------|-----------|--------|------|
| 18099 | 504-5101 | 4 | 4 | 7 | 1 | 0 | 16 |
| 18103 | 504-5105 | 0 | 1 | 7 | 11 | 1 | 20 |
| 18109 | 504-5117 | 0 | 0 | 1 | 10 | 0 | 11 |
| 18128 | 504-5129 | 1 | 0 | 1 | 1 | 3 |
| 18135 | 504-5137 | 0 | 0 | 1 | 5 | 0 | 6 |

### ダッシュボード対象数 (Ready/Waiting + Recovery, ランクR/L除外)

| パーツID | 商品コード | ダッシュボード対象 | Recovery含む |
|---------|-----------|------------------|--------------|
| 18099 | 504-5101 | **4** | +4 (Recovery) |
| 18103 | 504-5105 | **0** | +1 (Recovery) |
| 18109 | 504-5117 | **0** | 0 |
| 18128 | 504-5129 | **1** | 0 |
| 18135 | 504-5137 | **0** | 0 |

### 調査結果の解釈

1. **504-5101 (ユーカリグリーン)**: ダッシュボード対象 **4個**
   - Ready/Waiting が 4個あるため、ダッシュボードに表示される (指摘では「3個」)
   - Recovery 4個は条件次第で含まれる可能性あり

2. **504-5105 (ペブルグレー)**: ダッシュボード対象 **0個**
   - Ready/Waiting が 0、全て貸出中または Recovery
   - Recovery 1個はクリーニング完了後に対象となる見込み
   - 丹羽さんの確認「クリーニング完了後1SKU復活予定」と **一致**

3. **504-5117 (2P チャコールグレー)**: ダッシュボード対象 **0個**
   - Ready/Waiting/Recovery 全て 0
   - 全 11個が貸出中 (toC: 1, toB: 10)
   - 丹羽さんの確認「全て貸出中 (B向け抑え中)」と **一致**

4. **504-5129 (2.5P セサミブラウン)**: ダッシュボード対象 **1個**
   - Ready 1個あり
   - 指摘では「商品数0」だが、組み上げには他パーツ (共通シートパネル) も必要

5. **504-5137 (2.5P チャコールグレー)**: ダッシュボード対象 **0個**
   - Ready/Waiting/Recovery 全て 0
   - 全 6個が貸出中 (toC: 1, toB: 5)
   - 丹羽さんの確認「全在庫貸出中」と **一致**

### toB 貸出状況の詳細

504-5117 と 504-5137 の toB 貸出状況:

| 商品コード | 在庫ID | ステータス | 契約開始日 | 契約終了日 |
|-----------|--------|----------|-----------|-----------|
| 504-5117 | 173735 | InUse | 2025-11-28 | 2026-01-27 |
| 504-5117 | 173737 | InUse | 2025-12-11 | 2026-01-21 |
| 504-5117 | 173738 | InUse | 2025-12-19 | - |
| 504-5117 | 173739 | Preparing | - | - |
| 504-5117 | 175888-175893 | Preparing | - | - |
| 504-5137 | 173824 | InUse | 2025-09-03 | - |
| 504-5137 | 173825 | InUse | 2026-01-13 | - |
| 504-5137 | 175956 | Preparing | - | - |

- **Preparing** : B向け引当準備中 (まだ出荷前)
- **InUse** : 現在使用中

---

## 最終結論

**ダッシュボードの動作は正しい**

管理画面の確認結果と BigQuery の実データが一致していることを確認:

| 商品コード | 管理画面確認 | BigQuery 結果 | 判定 |
|-----------|-------------|---------------|------|
| 504-5105 | クリーニング完了後1SKU復活予定 | Recovery 1, Ready 0 | 一致 |
| 504-5117 | 全て貸出中 (B向け抑え中) | Lending 1 + LendingToB 10 | 一致 |
| 504-5137 | 全在庫貸出中 | Lending 1 + LendingToB 5 | 一致 |

### 差異の本質

- **パーツ表 (滞留在庫_期末減損在庫_表)** : 簿価が残っているパーツ全て (貸出中含む)
- **ダッシュボード** : 倉庫に物理的にある在庫 (Ready/Waiting/Recovery) のみ

両方とも正しく動作しており、「見ているものが違う」ことが差異の原因。

---

## ダッシュボード (mart.stagnant_stock_report) の現在値

### テーブル更新状況

| テーブル | 最終更新 | 更新頻度 | 用途 |
|---------|---------|---------|------|
| `mart.stagnant_stock_report` | 2026-01-15 09:02 | 毎日 | ダッシュボード表示用 |
| `mart.monthly_stock_valuation` | 2026-01-15 09:00 | 毎日 | 簿価データ |
| `finance.fixed_asset_register` | **2026-01-11 07:03** | **月1回** | 固定資産台帳 |

### v2 と v3 の依存関係の違い

**v2 (現在のダッシュボード)**
```
stagnant_stock_report
  └── stagnant_inventory_dashboard_v2.sql
        ├── mart.monthly_stock_valuation (毎日更新)
        └── finance.fixed_asset_register (月1回更新) ← ボトルネック
```

**v3 (改善版)**
```
stagnant_stock_report
  └── stagnant_inventory_dashboard_v3.sql
        ├── mart.monthly_stock_valuation (毎日更新)
        └── lake.stock.arrival_at (リアルタイム) ← 依存排除済み
```

### KINFORT ソファの現在のダッシュボード値

| SKU ID | 商品名 | カラー | total_product_count | term1減損 |
|--------|--------|--------|---------------------|-----------|
| 19750 | 2人掛け | ユーカリグリーン | **8** | 3 |
| 19751 | 2人掛け | ペブルグレー | **1** | 1 |
| 19749 | 2人掛け | チャコールグレー | **0** | 0 |
| 19764 | 2.5人掛け | セサミブラウン | **1** | 1 |
| 19763 | 2.5人掛け | チャコールグレー | **0** | 0 |

**注記**: Slackで言及された「3」は term1_impairment_product_count (期末1減損対象) の値。total_product_count は 8。

### 構成パーツ (ユーカリグリーン 2P の例)

| パーツID | パーツ名 |
|---------|---------|
| 18099 | 504-5101 KINFORTソファ2P フレーム & 背クッション / ユーカリグリーン |
| 18100 | KINFORTソファ 2P 共通シートパネル (2枚) |
| 18101 | KINFORTソファ ユーカリグリーン用サイズ共通 肘掛 & 脚 & 組立部品 |
| 18102 | 504-5104 KINFORTソファ 2P シートクッション / ユーカリグリーン |

---

## 補足: 更新遅延問題について

ミーティングで「1/13にステータスが変わったものが反映されていない可能性」が指摘されていた。

**原因の可能性**:
- v2 は `finance.fixed_asset_register` に依存
- このテーブルは月1回更新 (最終更新: 1/11)
- v3 ではこの依存を排除済み

**推奨対応**:
- ダッシュボードのクエリを v3 に更新することで、リアルタイム性が改善される

---

## 参考資料

- Slack議論: `docs/slack_discussion.md`
- ミーティング文字起こし: `docs/meeting_transcript.md`
- 対象クエリ: `sql/stagnant_inventory_dashboard_v3.sql`
