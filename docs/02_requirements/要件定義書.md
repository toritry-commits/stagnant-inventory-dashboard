
# 滞留在庫ダッシュボード 追加実装要件定義書

## 概要

本ドキュメントは、滞留在庫ダッシュボードの追加実装要件を定義するものである。
現状のAI商品選定ツール用SQLをベースに、減損対策・在庫可視化のための機能拡張を行う。

---

## 1. 現状のSQL（AI商品選定ツール用クエリ）で対応済みの機能

| 機能 | 対応状況 | 備考 |
|------|----------|------|
| SKU単位でのデータ出力 | ✅ | 連番方式で欠番も含む |
| 商品基本情報 | ✅ | シリーズ名、商品名、属性、カテゴリ等 |
| 組み上げ可能数（エリア別） | ✅ | 関東/関西/九州 × 貸出可能/リカバリー |
| 滞留日数（平均） | ✅ | パーツごとの平均 |
| 除外フラグ | ✅ | セット品、おまかせ、重複SKU等 |
| 戻り品情報 | ✅ | 利用可能日、利用可能数 |
| 重複SKU除外 | ✅ | 同一パーツ構成のSKUを1つに集約 |

---

## 2. 追加実装が必要な機能

### 2.1 滞留日数の変更（平均 → 最長）

#### 現状

```sql
-- 5-11. SKUごとの現在の平均滞留日数（倉庫在庫ベース）
sku_current_retention_avg AS (
  SELECT
    spm.sku_hash,
    ROUND(AVG(pcra.avg_current_retention_days), 1) AS avg_current_retention_days  -- ← 平均
  FROM sku_part_mapping spm
  ...
```

#### 変更内容

- `AVG` → `MAX` に変更
- 商品として組み上がる場合、構成パーツの中で**最も長く滞留しているものの日数**を表示

#### 変更理由

減損判定は最長滞留パーツで決まるため

---

### 2.2 減損予定日・減損予定点数の追加

#### 追加カラム

| カラム名 | 説明 |
|----------|------|
| 減損予定_2月末 | 2月末時点で減損対象になる点数 |
| 減損予定_5月末 | 5月末時点で減損対象になる点数 |
| 減損予定_8月末 | 8月末時点で減損対象になる点数 |
| 減損済み | 既に減損済みの点数 |

#### ロジック

- 在庫テーブルの減損日カラム（`finance.fixed_asset_register.impairment_date`等）を参照
- 各締め日時点での減損対象をカウント
- **組み上がる商品数単位でカウント**（パーツ単体ではない）

#### 確認事項

- [ ] 減損判定の閾値（滞留何日で減損対象？）
- [ ] 減損日のデータソース（`finance.fixed_asset_register`に存在する？）

---

### 2.3 組み上がらないパーツの可視化

#### 現状

- 組み上げ可能数が0でも滞留日数は表示される
- ただし「なぜ組み上がらないか」が分からない

#### 追加カラム

| カラム名 | 説明 |
|----------|------|
| 組み上げ可否 | TRUE/FALSE |
| 不足パーツ | 組み上がらない場合、不足しているパーツ名 |
| 余剰パーツ詳細 | 組み上がらないパーツの在庫数・滞留日数 |

#### ロジック

- 各パーツタイプ（Body, Leg, Mattress等）の在庫数を比較
- 1つでも0のパーツがあれば「組み上がらない」
- 不足パーツ名を表示

---

### 2.4 パーツ共有問題への対応（重複カウント問題）

#### 現状の問題

- 天板1種 + 脚3種 = 3つのSKU
- 脚10本しかないのに「10, 10, 10」と表示される（重複カウント）

#### 対応方針

- **現状は許容**（変に振り分けると0になるリスク）
- ただし「重複カウント注意」のフラグを追加することは検討

---

## 3. 実装優先度

| 優先度 | 項目 | 工数目安 | 備考 |
|--------|------|----------|------|
| **高** | 滞留日数を最長に変更 | 0.5日 | 既存ロジックの修正のみ |
| **高** | 減損予定日・点数の追加 | 1日 | 減損判定ロジックの確認が必要 |
| **中** | 組み上がらないパーツの可視化 | 1日 | 不足パーツの特定ロジック |
| **低** | 減損済みの点数 | 0.5日 | データソースの確認が必要 |

---

## 4. 確認事項（伊藤さん/野口さんへ）

### 4.1 減損判定の基準

- [ ] 滞留何日で減損対象になる？（365日？）
- [ ] 減損日はどのテーブルに格納されている？

### 4.2 減損済みデータ

- [ ] `finance.fixed_asset_register`に減損済みフラグはある？
- [ ] 簿価0のものが減損済み？

### 4.3 キャパ問題の可視化

- [ ] 減損済み在庫の点数/金額も同時に出すべき？
- [ ] PB/NB別の集計は必要？

---

## 5. 実装カラム定義

### 5.1 出力カラム一覧（41項目）

| No | カラム名 | 型 | 説明 | 計算ロジック |
|----|----------|-----|------|--------------|
| 1 | 画像 | STRING | 商品画像URL | lake.imageから生成 |
| 2 | SKU_ID | INT64 | SKU識別子 | 連番方式（1〜MAX）、昇順 |
| 3 | 商品ID | INT64 | 商品識別子 | lake.product.id |
| 4 | 画像リンク | STRING | 画像URL | 画像と同一 |
| 5 | 商品IDリンク | STRING | 管理画面リンク | https://clas.style/admin/product/{id}#images |
| 6 | シリーズ名 | STRING | シリーズ名称 | lake.series.name |
| 7 | 商品名 | STRING | 商品名称 | lake.product.name |
| 8 | 属性 | STRING | SKU属性値 | Body/Leg/Mattress等の値を結合 |
| 9 | カテゴリ | STRING | カテゴリ（日本語） | lake.series.categoryを日本語変換 |
| 10 | サブカテゴリ | STRING | サブカテゴリ | lake.product_tag + lake.tag |
| 11 | 対象顧客 | STRING | 顧客タイプ | 一般顧客/法人顧客 |
| 12 | サプライヤー | STRING | サプライヤー名 | lake.supplier.name |
| 13 | ブランド | STRING | ブランド名 | lake.brand.backyard_name |
| 14 | 除外フラグ | BOOL | 除外対象 | 欠番/削除済み/旧SKU/セット品/**SET**等 |
| 15 | 下代 | INT64 | 仕入価格 | パーツコストの合計 |
| 16 | 上代 | INT64 | 販売価格 | lake.product.retail_price |
| 17 | 滞留日数_平均 | INT64 | 平均滞留日数 | 構成パーツのAVG(滞留日数)、切り上げ |
| 18 | 在庫数_関東_リカバリー込 | INT64 | 関東在庫（リカバリー込） | Ready/Waiting + Recovery |
| 19 | 在庫数_関西_リカバリー込 | INT64 | 関西在庫（リカバリー込） | 同上 |
| 20 | 在庫数_九州_リカバリー込 | INT64 | 九州在庫（リカバリー込） | 同上 |
| 21 | 在庫数_合計_リカバリー込 | INT64 | 合計在庫（リカバリー込） | 関東+関西+九州 |
| 22 | 減損済み | INT64 | 既に減損済みの点数 | 現時点で365日以上滞留のパーツをMIN集計 |
| 23 | **2026年2月末_商品数** | INT64 | Q1新規減損予定（組み上げ分） | 組み上げ対象の減損見込み商品数 |
| 24 | **2026年5月末_商品数** | INT64 | Q2新規減損予定（組み上げ分） | 同上（2月末除く） |
| 25 | **2026年8月末_商品数** | INT64 | Q3新規減損予定（組み上げ分） | 同上（2,5月末除く） |
| 26 | **2026年2月末_余りパーツ数** | INT64 | Q1新規減損予定（余り分） | 余り在庫の減損見込みパーツ数 |
| 27 | **2026年5月末_余りパーツ数** | INT64 | Q2新規減損予定（余り分） | 同上（2月末除く） |
| 28 | **2026年8月末_余りパーツ数** | INT64 | Q3新規減損予定（余り分） | 同上（2,5月末除く） |
| 29 | **2026年2月末_商品+余りパーツ累計** | INT64 | 2月末までの累計 | 2月末_商品数 + 2月末_余りパーツ数 |
| 30 | **2026年5月末_商品+余りパーツ累計** | INT64 | 5月末までの累計 | 29 + 5月末_商品数 + 5月末_余りパーツ数 |
| 31 | **2026年8月末_商品+余りパーツ累計** | INT64 | 8月末までの累計 | 30 + 8月末_商品数 + 8月末_余りパーツ数 |
| 32 | **構成パーツid** | STRING | パーツid一覧 | part_id小さい順、改行区切り |
| 33 | **構成パーツ名** | STRING | パーツ名称一覧 | part_id順、改行区切り |
| 34 | **構成点数** | STRING | 各パーツのquantity | part_id順、改行区切り |
| 35 | **2026年2月末_在庫id** | STRING | 組み上げ対象の減損見込み | パーツごと改行区切り |
| 36 | **2026年5月末_在庫id** | STRING | 同上（2月末除く） | パーツごと改行区切り |
| 37 | **2026年8月末_在庫id** | STRING | 同上（2,5月末除く） | パーツごと改行区切り |
| 38 | **2026年2月末_在庫id(余り)** | STRING | 余り分の減損見込み | パーツごと改行区切り |
| 39 | **2026年5月末_在庫id(余り)** | STRING | 同上（2月末除く） | パーツごと改行区切り |
| 40 | **2026年8月末_在庫id(余り)** | STRING | 同上（2,5月末除く） | パーツごと改行区切り |
| 41 | **2026年11月末以降_在庫id(余り)** | STRING | 8月末時点で365日未満の余り | パーツごと改行区切り |

※ **太字** は今回新規追加・変更カラム

### 5.2 四半期末カラムの動的命名

会計期末は2月末、四半期末は2月末/5月末/8月末/11月末。
実行日に応じて動的にカラム名と計算対象が変わる。

| 実行日 | Q1 | Q2 | Q3 |
|--------|-------------|--------|--------|
| 2025/12/23 | 2026年2月末 | 2026年5月末 | 2026年8月末 |
| 2026/3/15 | 2026年5月末 | 2026年8月末 | 2026年11月末 |
| 2026/6/1 | 2026年8月末 | 2026年11月末 | 2027年2月末 |

### 5.3 組み上げロジック

**重要: 在庫数と同様に、減損数もエリア別（関東/関西/九州）で計算してから合計する**

#### エリア別計算フロー

1. SKUの構成パーツタイプ（Body, Leg, Mattress, MattressTopper）ごとに**エリア別**在庫を取得
2. **エリアごとに**各パーツタイプの在庫数÷quantityの**MIN**が「組み上げ可能数」
3. **エリアごとに**各パーツタイプで、在庫id小さい順で「組み上げ可能数×quantity」個までが**組み上げ対象**
4. **エリアごとに**それを超えた在庫が**余り**
5. **エリアごとに**各期間の減損見込み = 当該期末までに365日経過する在庫のみ抽出
6. 最後に**全エリアを合計**して出力

#### 計算例

| パーツ | 関東在庫 | 関西在庫 | 九州在庫 |
|--------|---------|---------|---------|
| Body(×1) | 10 | 5 | 2 |
| Leg(×4) | 40 | 12 | 4 |

- 関東: MIN(10÷1, 40÷4) = MIN(10, 10) = **10** 組み上げ可能
- 関西: MIN(5÷1, 12÷4) = MIN(5, 3) = **3** 組み上げ可能
- 九州: MIN(2÷1, 4÷4) = MIN(2, 1) = **1** 組み上げ可能
- **合計: 14** 組み上げ可能

減損数も同様にエリア別で計算 → 合計

### 5.4 在庫idカラムの表示形式

パーツidごとに改行区切り、減損対象の在庫idのみ表示：

```
7890: 100001, 100002, 100003
7891: 200001, 200002, 200003, 200004
```

### 5.5 累計カラムの計算ロジック

```
2月末_商品+余りパーツ累計 = 2月末_商品数 + 2月末_余りパーツ数

5月末_商品+余りパーツ累計 = (2月末_商品数 + 2月末_余りパーツ数)
                          + (5月末_商品数 + 5月末_余りパーツ数)

8月末_商品+余りパーツ累計 = (2月末_商品数 + 2月末_余りパーツ数)
                          + (5月末_商品数 + 5月末_余りパーツ数)
                          + (8月末_商品数 + 8月末_余りパーツ数)
```

### 5.6 データソース

| テーブル | 用途 |
|----------|------|
| lake.stock | 在庫情報 |
| lake.sku | SKU情報 |
| lake.product | 商品情報 |
| lake.series | シリーズ情報 |
| lake.brand | ブランド情報 |
| lake.image | 商品画像情報 |
| lake.part | パーツ情報（名称取得用） |
| lake.attribute / lake.attribute_value | 属性情報（Body, Leg等） |
| lake.attribute_value_part | パーツ紐づけ（quantity含む） |
| lake.product_tag / lake.tag | サブカテゴリ情報 |
| lake.product_customer | 対象顧客情報 |
| lake.supplier | サプライヤー情報 |
| lake.lent / lake.lent_to_b | 貸出履歴（滞留日数計算用） |
| finance.fixed_asset_register | 入庫日（資産台帳） |

### 5.7 減損判定基準

| 基準 | 閾値 |
|------|------|
| 減損対象 | 365日以上滞留 |
| 減損間近 | 300日以上365日未満 |
| 要注意 | 180日以上300日未満 |
| 正常 | 180日未満 |

---

## 6. 実装ファイル

| ファイル | 説明 |
|----------|------|
| `stagnant_inventory_dashboard.sql` | 滞留在庫ダッシュボード用SQL（新規作成） |
| `queries.sql` | AI商品選定ツール用SQL（既存・参考） |

---

## 7. 次のステップ

1. **伊藤さんへの確認**: このアウトプットで動けるか？
2. **野口さん/開発への相談**: 管理画面への実装可否、風早さんへの引き継ぎ可否
3. **ダッシュボード設計**: Looker Studio等での可視化設計

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-23 | 初版作成（MTGでの議論内容を整理） |
| 2025-12-23 | SQL実装完了、カラム定義表追加、BigQueryテスト完了 |
| 2025-12-23 | カラム構成変更（31項目）、四半期末動的命名、差分表示対応 |
| 2025-12-23 | カラム構成変更（41項目）：商品数/余りパーツ数分離、累計カラム追加、構成パーツ情報・在庫id詳細追加、除外フラグにSET追加 |
| 2025-12-23 | カラム構成変更（38項目）：画像リンク/サブカテゴリ/ブランド列を削除 |
| 2025-12-23 | 集計条件変更：ロケーションID 5402を除外対象から除外、ランクSを全て集計対象に変更 |

---

## 8. 今後の拡張予定

### 8.1 倉庫単位でのエリア分割

**背景：**
エリアごとに減損対策の戦略が異なるため、エリア別に独立したダッシュボードを作成する。

**対象倉庫（available_for_business = TRUE）：**

| エリア | 倉庫ID | 倉庫名 |
|--------|--------|--------|
| 関東 | 21 | 船橋 |
| 関東 | 23 | 東葛西ロジスティクスセンター |
| 関東 | 27 | 株式会社MAKE VALUE 川崎倉庫 |
| 関西 | 30 | 門真倉庫 |
| 九州 | 29 | キタザワ九州倉庫 |
| (対象外) | 20 | 法人直送 |

**実装方針：**
- 倉庫単位で別SQLファイルを作成（直送は除外）
- 各ファイルは該当倉庫の在庫のみを集計対象とする
- カラム構成はエリア別に最適化（他エリアの在庫数列を削除）

**ファイル構成（予定）：**
```
stagnant_inventory_dashboard_funabashi.sql      -- 船橋倉庫用
stagnant_inventory_dashboard_kasai.sql          -- 東葛西倉庫用
stagnant_inventory_dashboard_kawasaki.sql       -- 川崎倉庫用
stagnant_inventory_dashboard_kadoma.sql         -- 門真倉庫用
stagnant_inventory_dashboard_kyushu.sql         -- 九州倉庫用
```

**注意：**
- 倉庫IDは変更される可能性があるため、実装時に再確認すること
- 新倉庫が追加された場合は対応するSQLファイルの追加が必要|
