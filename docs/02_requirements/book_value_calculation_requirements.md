# 簿価計算対応 要件定義書（v3対応）

**作成日**: 2025-12-25
**ステータス**: 要件定義中
**対象**: 滞留在庫ダッシュボード v3

---

## 目次

1. [背景と目的](#背景と目的)
2. [現状の課題](#現状の課題)
3. [要件概要](#要件概要)
4. [対応方針](#対応方針)
5. [必要なデータ項目](#必要なデータ項目)
6. [スケジュール](#スケジュール)

---

## 背景と目的

### 現状（v2）

現在のダッシュボードでは、**取得原価（`stock.cost`）** を使用して減損予定額を計算している。

```sql
-- v2での計算方法
SUM(IFNULL(sac.cost, 0)) AS term1_cost
```

### 目的（v3）

**簿価（会計上の帳簿価額）** を正確に計算し、より精緻な減損予定額を算出する。

- 取得原価：購入時の価格（固定値）
- **簿価**：減価償却や評価損を反映した現在の会計上の価値

---

## 現状の課題

| 課題 | 説明 |
|------|------|
| 簿価計算が複雑 | 減価償却、評価損、在庫評価など複雑なロジック |
| データ不足 | 簿価計算に必要なデータがBigQueryに存在しない可能性 |
| 計算負荷 | 在庫ごとに簿価を計算するとクエリが重くなる恐れ |

---

## 要件概要

### 機能要件

1. **Pythonロジックの移植**
   - 既存のPython簿価計算ロジックをBigQuery SQLに移植

2. **データ準備**
   - 簿価計算に必要なデータをBigQueryに用意
   - 不足データの特定と取得方法の検討

3. **取得原価→簿価への置き換え**
   - 以下のカラムを簿価ベースに変更：
     - `期末1_減損予定_取得原価` → `期末1_減損予定_簿価`
     - `期末1_減損予定_取得原価_累計` → `期末1_減損予定_簿価_累計`
     - （期末2〜4も同様）

4. **後方互換性**
   - 必要に応じて取得原価カラムも残す（比較用）

### 非機能要件

| 項目 | 要件 |
|------|------|
| パフォーマンス | 現行（v2）と同程度の実行時間を維持 |
| 正確性 | Pythonロジックとの計算結果の一致を検証 |
| 保守性 | 計算ロジックをCTEで分離し、可読性を確保 |

---

## 対応方針

### フェーズ1: 調査・準備

1. **Pythonロジックの理解**
   - 簿価計算の全ステップを洗い出し
   - 使用するデータ項目をリスト化
   - 計算式を数式として整理

2. **データ調査**
   - 必要なデータがBigQueryに存在するか確認
   - 不足データの取得方法を検討
   - テーブル結合の設計

3. **テストケース設計**
   - Pythonで計算した期待値を用意
   - 検証用のstock_id（2-3件）を選定

### フェーズ2: 実装

1. **データ準備CTE作成**
   - 簿価計算に必要なデータを集約するCTE

2. **簿価計算CTE作成**
   - Pythonロジックを段階的にSQLへ移植
   - 中間結果を検証しながら進める

3. **既存CTEへの統合**
   - `sku_cost_summary` を `sku_book_value_summary` に拡張
   - 最終SELECTに簿価カラムを追加

### フェーズ3: 検証・リリース

1. **単体検証**
   - テストケースで期待値と一致するか確認

2. **結合検証**
   - 全体クエリの実行確認
   - パフォーマンステスト

3. **ドキュメント更新**
   - 技術仕様書に簿価計算ロジックを追記
   - ユーザーマニュアルの修正

---

## 必要なデータ項目

### Pythonロジックで使用するデータ（必須項目）

| データ項目 | 説明 | BigQueryテーブル候補 | データ型 | 備考 |
|-----------|------|-------------------|---------|------|
| 在庫ID | 在庫の一意識別子 | `lake.stock.id` | INT64 | 既存 |
| パーツID | パーツの一意識別子 | `lake.stock.part_id` | INT64 | 既存 |
| パーツ名 | パーツ名称 | `lake.part.name` | STRING | 既存 |
| **取得原価** | 購入時の価格 | `lake.stock.cost` | FLOAT64 | 既存 |
| **耐用年数** | 減価償却の期間（年） | `lake.part.useful_life_years` | INT64 | **要調査** |
| **入庫検品完了日** | 入庫して検品が完了した日 | `lake.stock.inspected_at` | DATE | **要確認** |
| 除売却日 | 除却または売却した日 | `lake.stock.impossibility_at` | DATE | 既存可能性あり |
| 破損紛失分類 | 除却理由の分類 | `lake.stock.classification_of_impossibility` | STRING | 既存可能性あり |
| サプライヤー名 | 仕入先名称 | `lake.supplier.name` | STRING | 要確認（JOIN必要） |
| **減損損失日** | 減損損失を計上した日 | `lake.stock.impairment_date` | DATE | **要調査** |

### オプション項目（特定ビジネスケースで使用）

| データ項目 | 説明 | BigQueryテーブル候補 | 使用ケース |
|-----------|------|-------------------|-----------|
| sample | サンプル品フラグ | `lake.stock.sample` | サンプル品は簿価計算対象外 |
| 貸手リース開始日 | 自社資産→賃貸債権に転換 | `lake.stock.lease_first_shipped_at` | リース債権への転換時 |
| 売却案件名 | 売却先の案件名 | `lake.stock.sale_project_name` | 売却時の記録 |
| 貸手リース案件名 | 貸手リース案件の名称 | `lake.stock.lease_project_name` | 貸手リース時の記録 |
| 初回出荷日 | 供与開始日（最初の出荷） | `lake.stock.first_shipped_at` | Pythonでは計算ロジックあり |

### 計算で導出する項目（SQL内で計算）

| データ項目 | 計算方法 |
|-----------|---------|
| 月次償却額 | `取得原価 / (耐用年数 × 12)` |
| 資産分類 | サプライヤー名とsampleフラグで判定（CASE文） |
| 会計ステータス | 資産分類・入庫日・除売却日・貸手リース開始日で判定 |
| リース再取得日 | サプライヤー名のパターンマッチで判定（REGEXP_EXTRACT） |
| 償却α/β/γ | 日付差分計算（DATE_DIFF） |
| 期首/増加/減少/期末 取得原価 | 日付範囲とステータスで判定 |
| 期首/増加/減少/期末 減価償却累計額 | 月次償却額 × 償却月数 |
| 期首/増加/減少/期末 減損損失累計額 | 減損日と簿価から計算 |
| **期首/増加/減少/期末 簿価** | 取得原価 - 減価償却累計額 - 減損損失累計額 |

### 新たに準備が必要なデータ（優先度順）

| データ項目 | 取得元候補 | 優先度 | 対応方針 |
|-----------|-----------|--------|---------|
| **耐用年数** | パーツマスタに追加 | 🔴 高 | パーツごとに固定値を設定、またはカテゴリ別デフォルト値 |
| **減損損失日** | 在庫テーブルに追加 | 🔴 高 | 減損判定ロジックを実装、または手動登録 |
| **入庫検品完了日** | `lake.stock` | 🟡 高 | `inspected_at`が存在するか確認、なければ代替項目を検討 |
| サプライヤーJOIN | `lake.supplier` | 🟡 中 | JOINでサプライヤー名を取得 |
| 初回出荷日 | 出荷履歴テーブル | 🟢 中 | 集計クエリで最小出荷日を取得、または計算ロジック実装 |
| リース関連項目 | 要件確認 | 🟢 低 | ビジネス要件で必要か確認後に対応 |

---

## 成果物

| 成果物 | 説明 |
|--------|------|
| `python_book_value_logic.py` | Pythonの簿価計算ロジック（参照用） |
| `stagnant_inventory_dashboard_v3.sql` | 簿価対応版クエリ |
| `book_value_calculation_spec.md` | 簿価計算の技術仕様書 |
| 技術仕様書（更新） | v3の変更内容を反映 |
| ユーザーマニュアル（更新） | 簿価カラムの説明を追加 |

---

## スケジュール（暫定）

| フェーズ | 内容 | 期間 |
|---------|------|------|
| フェーズ1 | Pythonロジック理解・データ調査 | TBD |
| フェーズ2 | SQL実装 | TBD |
| フェーズ3 | 検証・リリース | TBD |

---

## リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 必要データがBigQueryに存在しない | 高 | 代替データソースの検討、別途データ取込の実施 |
| 計算ロジックが複雑でSQL化困難 | 中 | ステップを細かく分割、中間テーブルの活用 |
| パフォーマンス劣化 | 中 | 計算の一部を事前集計、インデックス最適化 |

---

## 次のアクション

1. [ ] Pythonの簿価計算ロジックを `python_book_value_logic.py` に記述
2. [ ] 使用するデータ項目を洗い出し
3. [ ] BigQueryでのデータ存在確認
4. [ ] テストケース（stock_id）の選定

---

## 参考資料

- [v2技術仕様書](../03_design/stagnant_inventory_dashboard_v2_technical_spec.md)
- [v2 SQLファイル](../../sql/stagnant_inventory_dashboard_v2.sql)
- [Pythonロジック](../../book_value_calculation/python_book_value_logic.py)
