# 滞留在庫ダッシュボード SQL修正方針

## 1. 問題の概要

### 発見された問題
- `合計_余りパーツ数` と各期間の余りパーツ数の合計が一致しない
- 原因: 在庫カテゴリの判定ロジックと「2026年11月末以降」の計算方法に問題

### 根本原因
1. **カテゴリ判定ロジックの誤り**: 「2025年X月末時点で365日経過」で判定していたが、正しくは「365日到達日がいつか」で判定すべき
2. **減損済み在庫の扱い**: `impairment_date`が設定済みだが滞留日数が365日未満の在庫が、どのカテゴリにも属さない状態になっていた

---

## 2. 修正内容

### 2.1 在庫カテゴリ判定ロジックの修正

**修正前（誤）:**
```sql
WHEN DATE_DIFF(DATE('2025-02-28'), retention_start_date, DAY) >= 365 THEN 'q1'
```
→ 「2025年2月28日時点で365日経過」= 滞留開始が2024年2月28日以前

**修正後（正）:**
```sql
WHEN DATE_ADD(retention_start_date, INTERVAL 365 DAY) <= DATE('2026-02-28') THEN '2026-02'
```
→ 「365日到達日が2026年2月28日以前」

### 2.2 カテゴリ定義の変更

| 変更前 | 変更後 | 条件 |
|--------|--------|------|
| impaired | impaired（減損済み） | `impairment_date <= 今日` または `滞留開始日 + 365日 <= 今日` |
| q1 | 2026-02 | `滞留開始日 + 365日 <= 2026-02-28` |
| q2 | 2026-05 | `滞留開始日 + 365日 <= 2026-05-31` |
| q3 | 2026-08 | `滞留開始日 + 365日 <= 2026-08-31` |
| q4_after | 2026-11以降 | `滞留開始日 + 365日 > 2026-08-31` |

※ 「2026-11」「2027-02以降」を分ける必要はなく、「2026-11以降」に統合

### 2.3 組み上げ優先順位

**目的**: 減損を回避するため、早く減損するパーツを優先的に組み上げる

**優先順位（高→低）:**
1. 2026-02（最優先）
2. 2026-05
3. 2026-08
4. 2026-11以降
5. 減損済み（最後 = 余りになりやすい）

### 2.4 商品の減損時期の決定ロジック

**ルール**: 組み合わせる全パーツの中で、**減損済みを除いて最も早い減損カテゴリ**で決定

**理由**: 商品として出荷すれば、減損済みパーツも含めて減損を回避できる。そのため、まだ減損していないパーツの中で最も早く減損するものが、その商品の「減損回避期限」となる。

**例:**
- パーツA: 減損済み
- パーツB: 2026-11以降
- パーツC: 2026-02
- パーツD: 2026-05

→ 商品の減損時期 = **2026-02**（減損済みを除いて最も早い）

---

## 3. 修正対象箇所

### 3.1 `stock_with_category` または同等のCTE

```sql
-- 修正後のカテゴリ判定
CASE
  WHEN impairment_date IS NOT NULL AND impairment_date <= CURRENT_DATE() THEN 'impaired'
  WHEN DATE_ADD(retention_start_date, INTERVAL 365 DAY) <= CURRENT_DATE() THEN 'impaired'
  WHEN DATE_ADD(retention_start_date, INTERVAL 365 DAY) <= DATE('2026-02-28') THEN '2026-02'
  WHEN DATE_ADD(retention_start_date, INTERVAL 365 DAY) <= DATE('2026-05-31') THEN '2026-05'
  WHEN DATE_ADD(retention_start_date, INTERVAL 365 DAY) <= DATE('2026-08-31') THEN '2026-08'
  ELSE '2026-11after'
END AS category
```

### 3.2 組み上げ優先順位の設定

```sql
ROW_NUMBER() OVER (
  PARTITION BY part_id
  ORDER BY
    CASE category
      WHEN '2026-02' THEN 1
      WHEN '2026-05' THEN 2
      WHEN '2026-08' THEN 3
      WHEN '2026-11after' THEN 4
      WHEN 'impaired' THEN 5
    END,
    stock_id
) AS stock_order
```

### 3.3 商品の減損時期判定（在庫ID表示用）

```sql
-- 商品判定用カテゴリ順序（減損済みは除外するため99）
CASE
  WHEN category = 'impaired' THEN 99
  WHEN category = '2026-02' THEN 1
  WHEN category = '2026-05' THEN 2
  WHEN category = '2026-08' THEN 3
  WHEN category = '2026-11after' THEN 4
END AS category_order_for_product

-- 各商品の減損時期 = MIN(category_order_for_product) where category != 'impaired'
```

---

## 4. SKU ID 6での検証結果

### 4.1 余りパーツ

| 減損予定時期 | 余りパーツ数 |
|-------------|-------------|
| 減損済み | 9 |
| 2026年2月末 | 4 |
| 2026年5月末 | 19 |
| 2026年8月末 | 1 |
| 2026年11月末以降 | 11 |
| **合計** | **44** |

### 4.2 商品（組み上げ用）

| 減損予定時期 | 商品数 |
|-------------|--------|
| 2026年2月末 | 37 |
| **合計** | **37** |

### 4.3 検算
- 在庫合計: 37 + 44 + 54 + 57 = 192個
- 組み上げ用: 37 × 4 = 148個
- 余り: 192 - 148 = 44個 ✓

---

## 5. 影響範囲

### 修正が必要なカラム
- `減損済_余りパーツ数`
- `2026年2月末_減損予定_余りパーツ数`
- `2026年5月末_減損予定_余りパーツ数`
- `2026年8月末_減損予定_余りパーツ数`
- `2026年11月末以降_減損予定_余りパーツ数`
- `合計_余りパーツ数`
- `減損済_商品数` 
- `2026年2月末_減損予定_商品数`
- `2026年5月末_減損予定_商品数`
- `2026年8月末_減損予定_商品数`
- `2026年11月末以降_減損予定_商品数`
- 在庫ID表示用の各カラム

### 修正が必要なCTE
- `sku_area_part_stock`（または同等のカテゴリ判定箇所）
- `sku_area_leftover`（余りパーツ計算）
- `sku_leftover_summary`（余りパーツ集計）
- `sku_stock_ids_unified`（在庫ID表示）
- 商品数・商品用在庫ID関連のCTE

---

## 6. 実装手順

1. カテゴリ判定ロジックの修正（DATE_ADD方式に変更）
2. カテゴリ名の変更（q1→2026-02等）
3. 組み上げ優先順位の修正
4. 余りパーツ計算の修正
5. 商品数計算の修正（減損済み除外で最小カテゴリ）
6. 在庫ID表示の修正
7. カラム名の変更（必要に応じて）
8. テスト実行・検証
