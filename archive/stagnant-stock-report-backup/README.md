# 滞留在庫ダッシュボード 自動更新スクリプト

BigQuery（Googleの大規模データ分析サービス）にある滞留在庫レポートテーブルからデータを取得し、スプレッドシートに自動で書き込むGASです。

## 概要

| 項目 | 内容 |
|------|------|
| データ取得元 | BigQuery `clas-analytics.mart.stagnant_stock_report` |
| レコード数 | 約27,000行 |
| 更新タイミング | 毎朝9時（自動）または手動 |
| 書き込み範囲 | B列〜BO列（BigQueryデータ） |

## 機能

### スプレッドシートメニュー

スプレッドシートを開くと「滞留在庫レポート」メニューが表示されます：

```
滞留在庫レポート
├── 今すぐ更新
├── ─────────
├── 表示モード ▶
│   ├── 期末1・2のみ
│   └── 全期間
├── ─────────
├── 毎朝9時トリガーを設定
└── トリガーを削除
```

### 表示モードの説明

| モード | 表示する列 | 用途 |
|--------|-----------|------|
| **期末1・2のみ** | 基本情報 + term1/2のデータ | 直近の減損対象確認（デフォルト） |
| **全期間** | 全列 | 全体把握・分析 |

### データ処理の流れ

1. **フィルター解除** - 既存のフィルターを外す
2. **BP列以降のデータ保存** - SKU IDと紐づけて一時保存
3. **既存データクリア** - B〜BO列とA列のみクリア
4. **BigQueryクエリ実行** - SKU ID順でデータ取得
5. **BP列以降のデータ復元** - SKU IDで照合して復元
6. **ソート** - AY列（期末1減損予定簿価）で降順ソート
7. **IMAGE関数設定** - A列に画像を全件表示
8. **フィルター設定** - 全列にフィルター適用
9. **フィルター条件設定** - C列「除外」除外、AO列>0のみ表示
10. **条件付き書式設定** - BP列以降が空の行を薄い黄色でハイライト
11. **表示モード設定** - 「期末1・2のみ」をデフォルト適用

### フィルター条件（自動適用）

| 列 | 条件 | 説明 |
|----|------|------|
| C列（除外フラグ） | 「除外」を含まない | 除外対象を非表示 |
| AO列（期末1減損予定数） | 0より大きい | 減損対象がないSKUを非表示 |

### 条件付き書式（自動適用）

- **対象**: BP列以降がすべて空白の行
- **色**: 薄い黄色（#FFF9C4）
- **用途**: 手入力が必要な行を視覚的に識別

## 初回設定

### 1. BigQuery APIの有効化

GASエディタで以下の操作が必要です（初回のみ）：

1. GASエディタを開く（スプレッドシートの「拡張機能」→「Apps Script」）
2. 左側メニューの「サービス」をクリック
3. 「BigQuery API」を検索して追加

### 2. 毎朝9時の自動更新を設定

1. スプレッドシートを開く
2. メニュー「滞留在庫レポート」→「毎朝9時トリガーを設定」をクリック
3. 初回は権限の承認画面が表示されるので承認

## ファイル構成

```
stagnant-stock-report/
├── .clasp.json        # clasp設定（スクリプトID指定）
├── appsscript.json    # GASマニフェスト（BigQuery有効化）
├── Code.js            # メインスクリプト
└── README.md          # このファイル
```

## 注意事項

- **1行目のヘッダーは維持されます**: 日本語のヘッダーをあらかじめ設定しておいてください
- **BP列以降は自動復元**: SKU IDで照合して元の位置に戻します
- **処理時間**: 約3〜5分（27,000行のデータ処理 + 画像設定）
- **フィルター・表示モード**: 更新時に毎回リセットされます

## 開発

### コードの更新

```bash
cd "/mnt/c/Users/Naoto HIrose/Documents/stagnant-stock-report"
clasp push --force
```

### ログの確認

GASエディタの「実行」→「実行ログを表示」で確認できます。

## スクリプトID

```
1jHKC4xOrN0NH42Xy9yKaHw_thNu0S59Nq_TmsoaNCIYK25rXBney0NJf
```

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2026-01-06 | 画像全件表示、フィルター条件自動設定、表示モード整理、BP列以降の自動復元機能追加 |
| 2025-12-29 | 初版作成 |
